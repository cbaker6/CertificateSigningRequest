os: osx
osx_image: xcode11.6
language: objective-c

jobs:
  include:
    - stage: Build
      env: iOS
      xcode_workspace: Example/CertificateSigningRequest.xcworkspace
      xcode_scheme: CertificateSigningRequest-Example
      xcode_destination: platform=iOS Simulator,OS=13.6,name=iPhone 11 Pro Max
    - stage: Build
      env: Swift Package Manager
      script:
        - security create-keychain -p "" temporary
        - security default-keychain -s temporary
        - security unlock-keychain -p "" temporary
        - security set-keychain-settings -lut 7200 temporary
        - swift build
        - swift test --enable-code-coverage
        - xcrun llvm-cov export -format="lcov" .build/debug/CertificateSigningRequestPackageTests.xctest/Contents/MacOS/CertificateSigningRequestPackageTests -instr-profile .build/debug/codecov/default.profdata > info.lcov
        - bash <(curl https://codecov.io/bash)
    - stage: Release
      env: Cocoapods
      script:
        - pod lib lint
      deploy:
        - provider: script
          skip_cleanup: true
          script:
            - pod lib lint
            - source ~/.rvm/scripts/rvm
            - rvm use default
            - pod trunk push CertificateSigningRequest.podspec
          on:
            - tags: true
